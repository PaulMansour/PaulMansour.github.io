<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"></meta>
    <meta content="width=device-width, initial-scale=1" name="viewport"></meta>
    <link href="/ThorntonMelon.css" rel="stylesheet"></link>
  </head>
  <body>
    <header>
      <h1>Tool of Thought</h1>
      <h2>APL for the Practical Man</h2>
      <nav>
        <a href="/">Home</a>
        <a href="/posts">Posts</a>
        <a href="/projects">Projects</a>
        <a href="/donts">Don'ts</a>
        <a href="/links">Links</a>
        <a href="/about">About</a>
      </nav>
    </header>
    <main>
      <article>
        <header>
          <h1>
            <a href="/posts/boolean-techniques">Boolean Techniques</a>
          </h1>
          <h2>May 13, 2023</h2>
        </header>
        <p>In a recent post titled <a href="https://www.sacrideo.us/suggestivity-and-idioms-in-apl/">Suggestivity and Idioms in APL</a> on his blog <a href="https://www.sacrideo.us/tag/apl/">Fastidious Elegance</a> Arron Hsu enumerates all the permutations and combinations of logical pairwise reductions on Boolean vectors. There are 10 scalar dyadic relational functions and Aaron throws in <code>⊣</code> and  <code>⊢</code> as well for total of 12 functions. With the catenation of 1 or 0 on the front or the back, to keep the result the same shape as the input, there are <code>12×2×2</code> or <code>48</code> possible combinations. </p>
        <p>It would be convenient to be able to describe in short terms what each of these Boolean transformations does. If we can't meaningfully name them, we probably cannot effectively use them. If we are going to search for these expressions on, say, <a href="https://aplcart.info">APL Cart</a>, we need to have some way to describe them.</p>
        <p>In his 1987 book <strong>APL - Advanced Techniques and Utilities</strong>, Gary Bergquist uses the terms <em>maps</em> and  <em>poles</em> to facilitate discussion of Boolean vectors and techniques: </p>
        <blockquote>
          <p>A "maps" vector is a Boolean vector which consists of sets of contiguous 1s (1-maps) separated by one or more 0s, (0-maps). For example, the following bit vector contains 3 1-maps and 4 0-maps:</p>
          <pre><code>0 0 1 1 1 1 0 0 0 1 1 0 0 1 1 1 1 1 0 0
</code></pre>
          <p>A "leading" 1-poles vector is a Boolean vector which consists of pairs of 1s  separated by zero or more 0s. The 1's are called "poles".  The left pole in each pair may be viewed as the starting element of a set of contiguous elements.  The right pole in each pair may be viewed as the next element beyond the ending element of the set. For example, the following bit vector contains 3 pairs of leading 1-poles:</p>
          <pre><code>0 0 1 0 0 0 1 0 0 1 0 1 0 1 0 0 0 0 1 0  
</code></pre>
          <p>Notice that 1-maps and leading 1-poles are alternative means of conveying the  same information. Basically they identify spans of contiguous elements. 1-maps do so by using 1s to flag the elements within the spans. Leading 1-poles do so by using 1s to flag the starts of spans and the starts of non-spans (hence the  word "leading").</p>
        </blockquote>
        <p>We can of course flip the bits and discuss 0-maps and leading 0-poles as well.  With this terminolgy in hand, we can interpret  <code>≠\</code> as converting leading 1-poles to 1-maps, and <code>=\</code> as converting leading 0-poles to 0-maps.</p>
        <p>How many of Aaron's 48 permutations can be succinctly described with this lexicon? Gary defines and names 6 transformations, using shift-and-compare techniques that pre-date the introduction of n-wise reduction. We can find the corresponding 6 transformations in Aaron's 48 by inspection:  </p>
        <table>
          <thead>
            <tr><th class="left">            </th><th class="left">            </th><th class="left">                               </th></tr>
          </thead>
          <tbody>
            <tr><td class="left"> <code>R≠¯1↓0,R</code> </td><td class="left"> <code>{2≠/0,⍵}</code> </td><td class="left"> 1-maps to leading 1-poles     </td></tr>
            <tr><td class="left"> <code>R=¯1↓1,R</code> </td><td class="left"> <code>{2=/1,⍵}</code> </td><td class="left"> 0-maps to leading 0-poles     </td></tr>
            <tr><td class="left"> <code>R&gt;¯1↓0,R</code> </td><td class="left"> <code>{2&lt;/0,⍵}</code> </td><td class="left"> 1-maps to first 1 bits        </td></tr>
            <tr><td class="left"> <code>R≥¯1↓1,R</code> </td><td class="left"> <code>{2≤/1,⍵}</code> </td><td class="left"> 0-maps to first 0 bits        </td></tr>
            <tr><td class="left"> <code>R∨¯1↓0,R</code> </td><td class="left"> <code>{2∨/0,⍵}</code> </td><td class="left"> extend 1-maps to right by 1   </td></tr>
            <tr><td class="left"> <code>R∧¯1↓1,R</code> </td><td class="left"> <code>{2∧/1,⍵}</code> </td><td class="left"> extend 0-maps to right by 1   </td></tr>
          </tbody>
        </table>
        <p>From these, six related ones jump right out:</p>
        <table>
          <thead>
            <tr><th class="left">            </th><th class="left">            </th><th class="left">                                </th></tr>
          </thead>
          <tbody>
            <tr><td class="left"> <code>R≠1↓R,0</code>  </td><td class="left"> <code>{2≠/⍵,0}</code> </td><td class="left"> 1-maps to trailing 1-poles     </td></tr>
            <tr><td class="left"> <code>R=1↓R,1</code>  </td><td class="left"> <code>{2=/⍵,1}</code> </td><td class="left"> 0-maps to trailing 0-poles     </td></tr>
            <tr><td class="left"> <code>R&gt;1↓R,0</code>  </td><td class="left"> <code>{2&gt;/⍵,0}</code> </td><td class="left"> 1-maps to last 1 bits          </td></tr>
            <tr><td class="left"> <code>R≥1↓R,1</code>  </td><td class="left"> <code>{2≥/⍵,1}</code> </td><td class="left"> 0-maps to last 0 bits          </td></tr>
            <tr><td class="left"> <code>R∨1↓R,0</code>  </td><td class="left"> <code>{2∨/⍵,0}</code> </td><td class="left"> extend 1-maps to left by 1     </td></tr>
            <tr><td class="left"> <code>R∧1↓R,1</code>  </td><td class="left"> <code>{2∧/⍵,1}</code> </td><td class="left"> extend 0-maps to left by 1     </td></tr>
          </tbody>
        </table>
        <p>Aaron may be a bit optimistic when he writes that <em>almost all of the binary relations that we can imagine in use here find some meaningful interpretation</em>, but here we have 12 simple, visually suggestive, well-named expressions using the language of maps and poles. That's a good start. Can we find more?</p>
      </article>
      <article>
        <header>
          <h1>
            <a href="/posts/dont-trap-when-you-can-verify">Don't Trap When
            You Can Verify</a>
          </h1>
          <h2>May 11, 2023</h2>
        </header>
        <p>The other day I turned trapping off:</p>
        <pre><code>      600⌶1
2 
</code></pre>
        <p>And attempted to run a user command:</p>
        <pre><code>      ]display ⍳10
VALUE ERROR: Undefined name: exact
findCmdPos[1] exact←{6::⍵ ⋄ exact}~ASN ⍝ exact match?
</code></pre>
        <p>...which fails due to a <strong>micro trap</strong>.</p>
        <p>I'm not picking on user commands here, my apps do this all over the place and it's a bad idea. With trap control set to 1, virtually no aspect of my apps will run. I don't think that should be. Error guards are seductive because they are terse. It's a little annoying to write: </p>
        <pre><code>      {0=⎕NC 'exact':⍵ ⋄ exact}
</code></pre>
        <p>But the explicit test is a better practice. Sure, we can turn trap control on and off, we can put a stop flag in a function to get us to the point where we can safely turn trapping off to proceed to the error we are looking for, but it's all messy.</p>
        <p>There is virtually no scenario during development where we want a micro trap like this to not work. We are abusing the error guard. </p>
        <p>Many times we can avoid micro traps and even guards by refactoring.  Micro traps are often a sign of technical debt: we have no idea how or why a certain state arises, but it does, so we trap around it. Regardless, if we must handle the case instead of finding and eliminating the root cause, it is better to explicitly test for it.</p>
        <p>So this proscription is now added to the <a href="/donts">Dyalog APL Dont's</a> </p>
      </article>
      <article>
        <header>
          <h1>
            <a href="/posts/excel-column-names">Excel Column Names</a>
          </h1>
          <h2>May 8, 2023</h2>
        </header>
        <p>Phase I, problem 3, of the 2020 Dyalog Programming Contest, <strong>Excel-lent Columns</strong> is stated thus:</p>
        <blockquote>
          <p>A Microsoft Excel spreadsheet numbers its rows counting up from 1. However Excel's columns are labelled alphabetically — beginning with A–Z, then AA–AZ, BA– BZ, up to ZA–ZZ, then AAA–AAZ and so on. Write a function that, given a right argument which is a character scalar or nonempty vector representing a valid character Excel column identifier between A and XFD, returns the corresponding column number</p>
          <p>Hint: The Decode function <code>X⊥Y</code>.</p>
          <p>Examples:</p>
          <pre><code>      (fn) 'A'
1
      (fn) 'APL'
1104
</code></pre>
        </blockquote>
        <p>The solution is concise:</p>
        <pre><code>      N2I←{26⊥⎕A⍳⍵}
      N2I¨'A' 'Z' 'AA' 'AZ' 'BA'
1 26 27 52 53
</code></pre>
        <p>With such a simple solution, one would think the inverse would be fairly easy. That is, given an integer, return the corresponding column name. If <code>decode</code> solves it one way, certainly <code>encode</code> should solve it the other way:</p>
        <pre><code>      {(' ',⎕A)[1+26 26⊤⍵]}¨1 26 27 52 53 
 A  A   AA  B   BA 
</code></pre>
        <p>Clearly not correct. The problem is that the column names are not plain old base-26, but rather bijective base-26, as a recent August 22, 2022 answer to an <a href="https://stackoverflow.com/questions/181596/how-to-convert-a-column-number-e-g-127-into-an-excel-column-e-g-aa">old question on Stack Overflow makes clear.</a></p>
        <p>This is not handled well by <code>encode</code>. While it may be possible to post-process the result of <code>encode</code> to make this work, I have not found a solution in this direction. From the referenced question and answer we can use recursion to compute the correct answer: </p>
        <pre><code>      I2N←{
           ⍺←⎕A
           n←≢⍺
           i←{q←¯1+⌈⍵÷n
              a←⍵-n×q
              q=0:,a
              a,⍨∇ q}⍵
           ⍺[i]
       }
       I2N¨1 26 27 52 53
 A  Z  AA  AZ  BA  
</code></pre>
        <p>Both of these functions are fairly easy to convert to work on vectors, but it does get a little messy.</p>
        <p>The function <code>I2N</code> works for any number of digits, which is nice. But this being APL for the practical programmer, we note that Excel columns don't exceed ZZZ (in fact much less) so it is easy to generate all possible Excel column names:</p>
        <pre><code>      n←⊃,/,¨∘.,\3⍴⊂,¨⎕A
      10↑n
 A  B  C  D  E  F  G  H  I  J 
      ¯10↑n
 ZZQ  ZZR  ZZS  ZZT  ZZU  ZZV  ZZW  ZZX  ZZY  ZZZ 
</code></pre>
        <p>With this in hand, and precomputed if we are worried about performance, we can trivially solve both the original problem and its inverse, with a single self-inverse function:</p>
        <pre><code>      ColumnLookup←{
          ⍝ ⍵ ←→ Column Index or Name
          ⍝ ← ←→ Column Name or Index
          ⍺←⊃,/,¨∘.,\3⍴⊂,¨⎕A
          2=≡⍵:⍺⍳⍵
          ⍺[⍵]
          }   
       ColumnLookup 1 26 27 52 53
 A  Z  AA  AZ  BA 
       ColumnLookup ColumnLookup 1 26 27 52 53
1 26 27 52 53
</code></pre>
        <p>If we precompute the column names, this will be the fastest and the simplest solution, though all the solutions are petty fast, even with an <code>each</code>. </p>
      </article>
      <h2>
        <a href="/posts">More posts...</a>
      </h2>
    </main>
    <footer>
      <p>Copyright 2023 Paul S. Mansour</p>
    </footer>
  </body>
</html>
