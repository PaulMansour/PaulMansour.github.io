<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"></meta>
    <meta content="width=device-width, initial-scale=1" name="viewport"></meta>
    <link href="/ThorntonMelon.css" rel="stylesheet"></link>
  </head>
  <body>
    <header>
      <h1>Tool of Thought</h1>
      <h2>APL for the Practical Man</h2>
      <nav>
        <a href="/">Home</a>
        <a href="/posts">Posts</a>
        <a href="/projects">Projects</a>
        <a href="/donts">Don'ts</a>
        <a href="/links">Links</a>
        <a href="/about">About</a>
      </nav>
    </header>
    <main>
      <article>
        <header>
          <h1>
            <a href="/posts/how-would-you-write-this">How Would You Write
            This?</a>
          </h1>
          <h2>March 5, 2023</h2>
        </header>
        <p>This question was recently posed on the <a href="https://chat.stackexchange.com/rooms/52405/the-apl-orchard/">APL Orchard</a> regarding how the following logic should or  could be expressed given that an <code>:OrIf</code> cannot be mixed with an <code>:AndIf</code>: </p>
        <pre><code>       :If 'Linux'≡(⊃# ⎕WG'APLVersion')~'-64'
       :AndIf ~0∊⍴⎕CMD'which git'
       :OrIf 'Windows'≡(⊃# ⎕WG'APLVersion')~'-64'
       :AndIf ~0∊⍴⎕CMD'where git'
</code></pre>
        <p>Leaving aside the <code>:AndIf</code>/<code>:OrIf</code> issue, this style violates the prime  <a href="/donts">Dyalog Don't</a> directive <em>Don't use control structures</em>, especially in such a situation or context.</p>
        <p>A response was immediately forthcoming, cutting the Gordian knot:</p>
        <pre><code>:If ~0∊⎕CMD' git',⍨⊃'which' 'where'⌽⍨'Windows'≡'-64'~⍨⊃# ⎕WG'APLVersion'
</code></pre>
        <p>This is a much more APL-style solution as it removes all the essential control structures, and is also better from a general programming perspective as it removes all of the duplicated code. These two improvements are directly related; removing the control structures requires the  removal of the duplicated code. This is precisely why control structures should be avoided.  But dangling this much code off the end of an <code>:If</code> statement, or preceeding a dfn guard, still leaves a lot to be desired, and violates another <em>Dyalog Don't</em>. </p>
        <p>Why not name a function? How much easier on  the reader's eyes and brain is it to see:</p>
        <pre><code>     :If IsInstalled 'git' 
</code></pre>
        <p>or </p>
        <pre><code>     ~IsInstalled 'git':0 
</code></pre>
        <p>There is no need for a comment, either outside the function or inside the function. The name of the function and its literal argument say it all. Furthermore, by extracting <code>'git'</code> as an argument, we have a function that might be useful in many other places, and would make a good candiate for an item in a utility package. Even if the function is hard-coded in the application, and is only used once, the simple act of encapsulating and naming the code is very useful.</p>
        <p>Once we have a well-named function, we might even say, <em>who cares how the code is written!</em>   The fact that the code is in a function, that the function has a good name and a singular purpose, that the arguments are well-designed-- all of these things are more important than the style or technique of the code inside the function itself. It would be better to have the function named and then coded with all sorts of control structures than to have the naked APL-style solution following the :If statement.</p>
        <p>The benefits of an application composed of small, well-named and designed functions cannot be overstated. </p>
      </article>
      <article>
        <header>
          <h1>
            <a href="/posts/text2date">Text2Date, a New Repository</a>
          </h1>
          <h2>February 27, 2023</h2>
        </header>
        <p>In a <a href="/posts/text-to-date">previous post</a> I discussed the problem of converting time strings to time numbers. I have now extracted this functionality from our main application, rewritten it, and made it an open source project, imaginatively, but prematurely, named <a href="https://github.com/the-carlisle-group\Text2Date">Text2Date</a>.                       Text2Date uses a modified version of the Dyalog format pattern that is the left argument of <code>1200⌶</code>.</p>
        <p>One useful recent, simplifying, insight gained in the process of rewriting  is that differentiating between undelimited  and delimited fixed-width formats strings is useful. Delimited fixed-width time strings must line up - the elements must be in the exact positions specified in the format string.   Undelimited format strings do not require that the time strings line up. For example, the format string <code>MMDDYY</code> can easily  process the character matrix:</p>
        <pre><code>123124
10125
  72476
011523
</code></pre>
        <p>yielding four dates:</p>
        <pre><code>      'MMDDYY' Text2Date '123124' '10125' '  72476   ' '011523'
20241231 20250101 19760724 20230115
</code></pre>
        <p>When there are no delimiters, we don't need to worry about where an element starts or ends. The time string is just a text representation of a date time packed into an integer. A missing leading zero is no problem. Leading and trailing blanks are no problem. Data in this format shows up all the time in Excel and CSV files out in the wild. </p>
        <p>In the case of undelimited formats, there is also no need that the input are time strings, numeric is just as good, if not better. <code>Text2Date</code> is now misnamed, as this works:</p>
        <pre><code>      'MMDDYY' Text2Date 123124 10125 72476 011523
20241231 20250101 19760724 20230115
</code></pre>
        <p>Three special format strings are also accepted: <code>Excel</code> or <code>Excel1900</code>, and <code>Excel1904</code>, which also work on text or numeric input:</p>
        <pre><code>      'Excel' Text2Date 35000 37125 41256
19951028 20010822 20121213
      'Excel' Text2Date '35000' '37125' '41256'
19951028 20010822 20121213
</code></pre>
      </article>
      <article>
        <header>
          <h1>
            <a href="/posts/error-trapping">Error Trapping</a>
          </h1>
          <h2>February 20, 2023</h2>
        </header>
        <p>Once we have written some nice, succinct APL code, it is disheartening to muck it all up with error trapping. There are many techniques, and often we just sling <code>⎕TRAP</code>, <code>:Trap</code>, <code>⎕SIGNAL</code> and error guards willy-nilly. It would be nice have to some tried and true patterns to apply, and extract as much messiness as possible.</p>
        <p>The best error trapping is none at all, or rather, left to functions further up the stack. But if we are providing a package to be used by others, and the API consists of more than utility functions like deleting extraneous blanks, we should provide some minimal distinction between a user error and a bug. This post explores one possible pattern, used in the <a href="https://github.com/the-carlisle-group/Text2Date">Text2Date</a> project.</p>
        <p>For some packages, there is no need to invent new error numbers and  event messages. However, we need a way to distinguish between, say, a length error that we anticipate, and one that we don't.  Two functions will suffice to extract all the needed logic:</p>
        <pre><code>Signal←{
     ⎕SIGNAL⊂('EN'(⍺+500))('Message'⍵)
 }
</code></pre>
        <p>and</p>
        <pre><code>f←ReSignal
f←⎕SIGNAL{
    ⊂('EN'(⍵.EN-500))('Message'⍵.Message)
}
</code></pre>
        <p>The <code>Signal</code> function wraps <code>⎕SIGNAL</code>, and specifies the <strong>error number</strong> and <strong>message</strong> for <code>⎕DMX</code>. The error number is bumped up by an arbitrary multiple of 100 (from 100 to 900), to distinguish it from an unexpected error. So, for example, if the left argument to an API function requires a 1 or 0, to signal a DOMAIN ERROR we might write:</p>
        <pre><code>~⍺∊0 1:11 Signal 'The left argument must be 0 or 1'
</code></pre>
        <p>Note that <code>Signal</code> reverses the arguments of <code>⎕SIGNAL</code>. This is because <code>⎕SIGNAL</code> is more often than not called with <code>⍨</code> as the right argument is almost always a literal scalar, while the left argument is often constructed. </p>
        <p>At the top of any API function we include the error guard:  </p>
        <pre><code>500+⍳100::ReSignal ⎕DMX
</code></pre>
        <p>This traps all errors in our arbitrary block of 100, and using <code>ReSignal</code> propagates expected errors to the calling function. Unexpected errors remain untrapped and fail where they are. <code>ReSignal</code> only specifies the event number <code>EN</code> and <code>Message</code> for <code>⎕DMX</code>. The event message <code>EM</code> is automatically provided. <code>ReSignal</code> is a niladic trad function that returns a function. The reason for this subterfuge is that we want to encapsulate the right side of this error guard:</p>
        <pre><code>300+⍳100::⎕SIGNAL ⊂('EN'(⎕DMX.EN-500))('Message'⎕DMX.Message)
</code></pre>
        <p>as this is far too much code to be copying and pasting all over the place. But <code>⎕SIGNAL</code> itself cannot be wrapped inside a function (trad or dfn) or it will not break out of the main function. It must signal in the scope of the main API function. The code to the right of <code>⎕SIGNAL</code> could easily be wrapped, but it would be nice to include the whole thing. Thus the trad function <code>ReSignal</code> returns a function that includes the whole thing, but keeps the <code>⎕SIGNAL</code> out of the subfunction.  This encapsulation technique is lifted from <a href="https://github.com/abrudz/dyalog_vision/blob/main/%E2%88%86SIGNAL.aplf">Adám Brudzewsky</a>.                                                             </p>
      </article>
      <h2>
        <a href="/posts">More posts...</a>
      </h2>
    </main>
    <footer>
      <p>Copyright 2023 Paul S. Mansour</p>
    </footer>
  </body>
</html>
